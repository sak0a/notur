name: E2E Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  e2e:
    name: E2E Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-e2e-docker-${{ hashFiles('docker/e2e/Dockerfile') }}
          restore-keys: ${{ runner.os }}-e2e-docker-

      - name: Build and run E2E tests
        run: |
          cd docker/e2e
          docker compose build
          docker compose up -d db app

          # Wait for MySQL health check
          echo "Waiting for MySQL..."
          retries=0
          until docker compose exec -T db mysqladmin ping -h 127.0.0.1 -u root -pnotur_e2e --silent 2>/dev/null; do
            retries=$((retries + 1))
            if [ "$retries" -ge 60 ]; then
              echo "MySQL did not become ready"
              docker compose logs db
              exit 1
            fi
            sleep 2
          done
          echo "MySQL is ready"

          # Install Notur into the panel using current branch code
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl

            # Install from current branch via path repository (tests latest code, not Packagist)
            composer config repositories.notur path /opt/notur --no-interaction
            composer require notur/notur:@dev --no-interaction 2>&1

            # Inject Notur scripts into Blade layout
            SCRIPTS_BLADE="resources/views/layouts/scripts.blade.php"
            WRAPPER_BLADE="resources/views/templates/wrapper.blade.php"
            if [ -f "${SCRIPTS_BLADE}" ]; then
              TARGET_BLADE="${SCRIPTS_BLADE}"
            elif [ -f "${WRAPPER_BLADE}" ]; then
              TARGET_BLADE="${WRAPPER_BLADE}"
            fi

            if [ -n "${TARGET_BLADE:-}" ] && ! grep -q "notur::scripts" "${TARGET_BLADE}"; then
              echo "" >> "${TARGET_BLADE}"
              echo "@include(\"notur::scripts\")" >> "${TARGET_BLADE}"
            fi

            # Apply React source patches (skip reverse patches)
            PATCH_DIR="vendor/notur/notur/installer/patches/v1.11"
            if [ -d "${PATCH_DIR}" ]; then
              for patch in "${PATCH_DIR}"/*.patch; do
                [ -f "${patch}" ] || continue
                PATCH_NAME=$(basename "${patch}")
                echo "${PATCH_NAME}" | grep -q "reverse" && continue
                echo "Applying patch: ${PATCH_NAME}"
                patch --dry-run -p1 < "${patch}" &>/dev/null && patch -p1 < "${patch}" || echo "Skipping: ${PATCH_NAME}"
              done
            fi

            # Rebuild frontend with patches applied
            yarn install --frozen-lockfile 2>&1 || npm install 2>&1
            yarn run build:production 2>&1 || true

            # Set up Notur directories and copy bridge
            mkdir -p notur/extensions public/notur/extensions
            BRIDGE_JS="vendor/notur/notur/bridge/dist/bridge.js"
            if [ ! -f "${BRIDGE_JS}" ]; then
              echo "Bridge runtime missing; building..."
              if [ -d "vendor/notur/notur/bridge" ]; then
                cd vendor/notur/notur/bridge
                bun install --frozen-lockfile 2>&1 || npm install 2>&1
                bun run build 2>&1 || bunx webpack --mode production 2>&1 || npm run build 2>&1 || true
                cd /var/www/pterodactyl
              fi
            fi
            if [ -f "${BRIDGE_JS}" ]; then
              cp "${BRIDGE_JS}" public/notur/bridge.js
            fi

            # Initialize extensions.json
            [ -f notur/extensions.json ] || echo "{\"extensions\":{}}" > notur/extensions.json

            # Run migrations
            php artisan migrate --force 2>&1

            # Fix permissions
            chown -R www-data:www-data storage bootstrap/cache notur public/notur 2>/dev/null || true
          '

          # Install test extension
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl
            mkdir -p notur/extensions/notur/hello-world
            cp -r /opt/notur/examples/hello-world/* notur/extensions/notur/hello-world/
            echo "{\"extensions\":{\"notur/hello-world\":{\"enabled\":true,\"version\":\"1.0.0\"}}}" > notur/extensions.json
            mkdir -p public/notur/extensions/notur/hello-world
            cp notur/extensions/notur/hello-world/resources/frontend/dist/hello-world.js \
               public/notur/extensions/notur/hello-world/hello-world.js 2>/dev/null || true
          '

          # Run tests
          docker compose run --rm test-runner

      - name: Collect logs on failure
        if: failure()
        run: |
          cd docker/e2e
          docker compose logs app > /tmp/app-logs.txt 2>&1
          docker compose logs db > /tmp/db-logs.txt 2>&1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: /tmp/*-logs.txt

      - name: Cleanup
        if: always()
        run: |
          cd docker/e2e
          docker compose down -v --remove-orphans 2>/dev/null || true

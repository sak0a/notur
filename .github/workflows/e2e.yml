name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e:
    name: E2E Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-e2e-docker-${{ hashFiles('docker/e2e/Dockerfile') }}
          restore-keys: ${{ runner.os }}-e2e-docker-

      - name: Build and run E2E tests
        run: |
          cd docker/e2e
          docker compose build
          docker compose up -d db app

          # Wait for MySQL health check
          echo "Waiting for MySQL..."
          retries=0
          until docker compose exec -T db mysqladmin ping -h 127.0.0.1 -u root -pnotur_e2e --silent 2>/dev/null; do
            retries=$((retries + 1))
            if [ "$retries" -ge 60 ]; then
              echo "MySQL did not become ready"
              docker compose logs db
              exit 1
            fi
            sleep 2
          done
          echo "MySQL is ready"

          # Setup panel
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl
            php artisan key:generate --force
            php artisan migrate --force 2>&1 || true
          '

          # Install Notur
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl
            mkdir -p vendor/notur/notur
            cp -r /opt/notur/* vendor/notur/notur/ 2>/dev/null || true
            bash vendor/notur/notur/installer/install.sh /var/www/pterodactyl 2>&1 || {
              php artisan migrate --force 2>&1
              mkdir -p notur/extensions public/notur/extensions
              echo "{\"extensions\":{}}" > notur/extensions.json
            }
          '

          # Install test extension
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl
            mkdir -p notur/extensions/notur/hello-world
            cp -r /opt/notur/examples/hello-world/* notur/extensions/notur/hello-world/
            echo "{\"extensions\":{\"notur/hello-world\":{\"enabled\":true,\"version\":\"1.0.0\"}}}" > notur/extensions.json
            mkdir -p public/notur/extensions/notur/hello-world
            cp notur/extensions/notur/hello-world/resources/frontend/dist/hello-world.js \
               public/notur/extensions/notur/hello-world/hello-world.js 2>/dev/null || true
          '

          # Run tests
          docker compose run --rm test-runner

      - name: Collect logs on failure
        if: failure()
        run: |
          cd docker/e2e
          docker compose logs app > /tmp/app-logs.txt 2>&1
          docker compose logs db > /tmp/db-logs.txt 2>&1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: /tmp/*-logs.txt

      - name: Cleanup
        if: always()
        run: |
          cd docker/e2e
          docker compose down -v --remove-orphans 2>/dev/null || true

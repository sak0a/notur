name: E2E Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  e2e:
    name: E2E Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-e2e-docker-${{ hashFiles('docker/e2e/Dockerfile') }}
          restore-keys: ${{ runner.os }}-e2e-docker-

      - name: Build and run E2E tests
        run: |
          cd docker/e2e
          docker compose build
          docker compose up -d db app

          # Wait for MySQL health check
          echo "Waiting for MySQL..."
          retries=0
          until docker compose exec -T db mysqladmin ping -h 127.0.0.1 -u root -pnotur_e2e --silent 2>/dev/null; do
            retries=$((retries + 1))
            if [ "$retries" -ge 60 ]; then
              echo "MySQL did not become ready"
              docker compose logs db
              exit 1
            fi
            sleep 2
          done
          echo "MySQL is ready"

          # Install Notur into the panel using current branch code
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl
            set -euo pipefail
            export NODE_OPTIONS=--openssl-legacy-provider

            # Install from current branch via path repository (tests latest code, not Packagist)
            git config --global --add safe.directory /opt/notur
            composer config platform.php 8.2.30 --no-interaction
            composer config audit.block-insecure false --no-interaction
            composer config audit.ignore "PKSA-8qx3-n5y5-vvnd,PKSA-w7xr-vk7n-rstm" --no-interaction
            composer config repositories.notur "{\"type\":\"path\",\"url\":\"/opt/notur\",\"options\":{\"symlink\":false}}" --no-interaction
            if ! COMPOSER_ALLOW_SUPERUSER=1 COMPOSER_DISABLE_AUDIT=1 composer require notur/notur:@dev --no-interaction --with-all-dependencies 2>&1; then
              echo "Composer require failed. Retrying once with verbose output..."
              COMPOSER_ALLOW_SUPERUSER=1 COMPOSER_DISABLE_AUDIT=1 composer require notur/notur:@dev --no-interaction --with-all-dependencies -vvv
              exit 1
            fi

            # Ensure DB settings in .env match docker-compose environment
            if [ -f ".env" ]; then
              sed -i "s/^DB_CONNECTION=.*/DB_CONNECTION=mysql/" .env
              sed -i "s/^DB_HOST=.*/DB_HOST=db/" .env
              sed -i "s/^DB_PORT=.*/DB_PORT=3306/" .env
              sed -i "s/^DB_DATABASE=.*/DB_DATABASE=panel/" .env
              sed -i "s/^DB_USERNAME=.*/DB_USERNAME=pterodactyl/" .env
              sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=pterodactyl/" .env
            fi

            # Inject Notur scripts into Blade layout
            SCRIPTS_BLADE="resources/views/layouts/scripts.blade.php"
            WRAPPER_BLADE="resources/views/templates/wrapper.blade.php"
            if [ -f "${SCRIPTS_BLADE}" ]; then
              TARGET_BLADE="${SCRIPTS_BLADE}"
            elif [ -f "${WRAPPER_BLADE}" ]; then
              TARGET_BLADE="${WRAPPER_BLADE}"
            fi

            if [ -n "${TARGET_BLADE:-}" ] && ! grep -q "notur::scripts" "${TARGET_BLADE}"; then
              echo "" >> "${TARGET_BLADE}"
              echo "@include(\"notur::scripts\")" >> "${TARGET_BLADE}"
            fi

            # Apply React source patches (skip reverse patches)
            PATCH_DIR="vendor/notur/notur/installer/patches/v1.11"
            if [ -d "${PATCH_DIR}" ]; then
              for patch in "${PATCH_DIR}"/*.patch; do
                [ -f "${patch}" ] || continue
                PATCH_NAME=$(basename "${patch}")
                echo "${PATCH_NAME}" | grep -q "reverse" && continue
                echo "Applying patch: ${PATCH_NAME}"
                if patch --dry-run -p1 < "${patch}" &>/dev/null; then
                  patch -p1 < "${patch}"
                  echo "Applied: ${PATCH_NAME}"
                else
                  echo "Skipping: ${PATCH_NAME} (already applied or incompatible)"
                fi
              done
            fi

            # Rebuild frontend with patches applied
            echo "Installing frontend dependencies..."
            yarn install --frozen-lockfile 2>&1 || npm install 2>&1

            echo "Building production assets..."
            if yarn run build:production 2>&1; then
              echo "Frontend build succeeded"
            else
              echo "Frontend build failed"
              exit 1
            fi

            if [ ! -f "public/assets/manifest.json" ]; then
              echo "Build artifacts missing: public/assets/manifest.json"
              ls -la public/assets 2>/dev/null || true
              exit 1
            fi

            # Set up Notur directories and copy bridge
            mkdir -p notur/extensions public/notur/extensions
            BRIDGE_JS="vendor/notur/notur/bridge/dist/bridge.js"
            if [ ! -f "${BRIDGE_JS}" ]; then
              echo "Bridge runtime missing; building..."
              if [ -d "vendor/notur/notur" ]; then
                cd vendor/notur/notur
                NODE_OPTIONS=--openssl-legacy-provider bun install --frozen-lockfile 2>&1 || NODE_OPTIONS=--openssl-legacy-provider npm install 2>&1
                if ! NODE_OPTIONS=--openssl-legacy-provider bun run build:bridge 2>&1; then
                  if ! NODE_OPTIONS=--openssl-legacy-provider npm run build:bridge 2>&1; then
                    if [ -d "bridge" ]; then
                      cd bridge
                      if ! NODE_OPTIONS=--openssl-legacy-provider bunx webpack --mode production 2>&1; then
                        echo "Bridge build failed"
                        exit 1
                      fi
                      cd ..
                    else
                      echo "Bridge build failed (bridge directory missing)"
                      exit 1
                    fi
                  fi
                fi
                cd /var/www/pterodactyl
              fi
            fi
            if [ -f "${BRIDGE_JS}" ]; then
              cp "${BRIDGE_JS}" public/notur/bridge.js
            else
              echo "Bridge runtime missing after build"
              exit 1
            fi

            # Initialize extensions.json
            [ -f notur/extensions.json ] || echo "{\"extensions\":{}}" > notur/extensions.json

            # Ensure package discovery + routes are registered
            php artisan package:discover --ansi 2>&1 || true
            php artisan config:clear 2>&1 || true
            php artisan route:clear 2>&1 || true

            # Run migrations (core + Notur package explicitly)
            php artisan migrate --force 2>&1
            php artisan migrate --path=vendor/notur/notur/database/migrations --force 2>&1

            # Verify Notur tables exist
            TABLES=$(mysql --ssl=0 -h db -P 3306 -u pterodactyl -ppterodactyl panel -e "SHOW TABLES LIKE \"notur_%\";" 2>/tmp/mysql-check.err || true)
            if ! echo "$TABLES" | grep -q "notur_"; then
              echo "Notur tables missing after migration"
              if [ -s /tmp/mysql-check.err ]; then
                echo "MySQL error output:"
                cat /tmp/mysql-check.err
              fi
              mysql --ssl=0 -h db -P 3306 -u pterodactyl -ppterodactyl panel -e "SHOW TABLES;" 2>/dev/null || true
              exit 1
            fi

            # Fix permissions
            chown -R www-data:www-data storage bootstrap/cache notur public/notur 2>/dev/null || true
          '

          # Install test extension
          docker compose exec -T app bash -c '
            cd /var/www/pterodactyl
            set -euo pipefail
            mkdir -p notur/extensions/notur/hello-world
            cp -r /opt/notur/examples/hello-world/* notur/extensions/notur/hello-world/
            echo "{\"extensions\":{\"notur/hello-world\":{\"enabled\":true,\"version\":\"1.0.0\"}}}" > notur/extensions.json
            mkdir -p public/notur/extensions/notur/hello-world
            cp notur/extensions/notur/hello-world/resources/frontend/dist/hello-world.js \
               public/notur/extensions/notur/hello-world/hello-world.js 2>/dev/null || true

            # Refresh caches and ensure Notur migrations are applied
            php artisan config:clear 2>/dev/null || true
            php artisan route:clear 2>/dev/null || true
            php artisan cache:clear 2>/dev/null || true
            php artisan migrate --path=vendor/notur/notur/database/migrations --force 2>&1

            chown -R www-data:www-data notur public/notur 2>/dev/null || true

            # Verify extension routes are registered
            if ! php artisan route:list 2>/dev/null | grep -q "notur/hello-world"; then
              echo "Notur extension routes not registered"
              php artisan route:list 2>/dev/null | grep -i notur || true
              exit 1
            fi
          '

          # Run tests
          docker compose run --rm test-runner

      - name: Collect logs on failure
        if: failure()
        run: |
          cd docker/e2e
          docker compose logs app > /tmp/app-logs.txt 2>&1
          docker compose logs db > /tmp/db-logs.txt 2>&1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: /tmp/*-logs.txt

      - name: Cleanup
        if: always()
        run: |
          cd docker/e2e
          docker compose down -v --remove-orphans 2>/dev/null || true

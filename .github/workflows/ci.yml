name: CI

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master]

jobs:
  php-unit-tests:
    name: PHP ${{ matrix.php }} Unit Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.3', '8.4']

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: sodium, mbstring, json
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run unit tests
        run: ./vendor/bin/phpunit --testsuite Unit

  php-integration-tests:
    name: PHP ${{ matrix.php }} / ${{ matrix.database.type }} Integration
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.3', '8.4']
        database:
          - { type: 'mysql', image: 'mysql:8.0', port: 3306 }
          - { type: 'mariadb', image: 'mariadb:10.6', port: 3306 }

    services:
      database:
        image: ${{ matrix.database.image }}
        env:
          MYSQL_ROOT_PASSWORD: testing
          MYSQL_DATABASE: notur_test
          MYSQL_USER: notur
          MYSQL_PASSWORD: notur
          MARIADB_ROOT_PASSWORD: testing
          MARIADB_DATABASE: notur_test
          MARIADB_USER: notur
          MARIADB_PASSWORD: notur
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u root -ptesting"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=30

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: sodium, mbstring, json, pdo_mysql
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Wait for database
        run: |
          for i in $(seq 1 30); do
            mysqladmin ping -h 127.0.0.1 -u root -ptesting --silent 2>/dev/null && break
            sleep 2
          done

      - name: Run integration tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: notur_test
          DB_USERNAME: notur
          DB_PASSWORD: notur
        run: ./vendor/bin/phpunit --testsuite Integration

  frontend-build:
    name: Frontend Build (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ['20', '22']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build bridge
        run: bun run build:bridge

      - name: Build SDK
        run: bun run build:sdk

      - name: Build hello-world example
        run: cd examples/hello-world && bunx webpack --mode production

      - name: Run frontend tests
        run: bun run test:frontend || true  # Allow failure until jest config is finalized

  patch-validation:
    name: Validate Patches (${{ matrix.panel-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - panel-version: v1.11
            panel-tag: v1.11.11
          - panel-version: v1.12
            panel-tag: v1.12.0

    steps:
      - uses: actions/checkout@v4

      - name: Clone Pterodactyl Panel
        run: git clone --depth 1 --branch ${{ matrix.panel-tag }} https://github.com/pterodactyl/panel.git /tmp/pterodactyl-panel

      - name: Verify forward patches apply
        run: |
          cd /tmp/pterodactyl-panel
          for patch in $GITHUB_WORKSPACE/installer/patches/${{ matrix.panel-version }}/*.patch; do
            [[ "$(basename "$patch")" == *.reverse.patch ]] && continue
            echo "Testing: $(basename $patch)"
            patch --dry-run -p1 < "$patch"
            echo ""
          done

      - name: Verify reverse patches apply
        run: |
          cd /tmp/pterodactyl-panel
          # Apply forward patches first so reverse patches have something to reverse
          for patch in $GITHUB_WORKSPACE/installer/patches/${{ matrix.panel-version }}/*.patch; do
            [[ "$(basename "$patch")" == *.reverse.patch ]] && continue
            patch -p1 < "$patch"
          done
          for patch in $GITHUB_WORKSPACE/installer/patches/${{ matrix.panel-version }}/*.reverse.patch; do
            [ -f "$patch" ] || continue
            echo "Testing: $(basename $patch)"
            patch --dry-run -p1 < "$patch"
            echo ""
          done

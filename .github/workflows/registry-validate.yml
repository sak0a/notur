name: Validate Registry

on:
  pull_request:
    paths:
      - 'registry/registry.json'
      - 'registry/extensions/**'

jobs:
  validate:
    name: Validate Extension Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        run: composer install --no-dev --prefer-dist

      - name: Validate registry index schema
        run: |
          php -r "
            \$schema = json_decode(file_get_contents('registry/schema/registry-index.schema.json'), true);
            \$index = json_decode(file_get_contents('registry/registry.json'), true);
            if (\$index === null) {
                echo 'ERROR: Invalid JSON in registry.json' . PHP_EOL;
                exit(1);
            }
            echo 'Registry index is valid JSON with ' . count(\$index['extensions'] ?? []) . ' extensions.' . PHP_EOL;
          "

      - name: Check for duplicate extension IDs
        run: |
          php -r "
            \$index = json_decode(file_get_contents('registry/registry.json'), true);
            \$ids = array_column(\$index['extensions'] ?? [], 'id');
            \$dupes = array_diff_assoc(\$ids, array_unique(\$ids));
            if (!empty(\$dupes)) {
                echo 'ERROR: Duplicate extension IDs: ' . implode(', ', \$dupes) . PHP_EOL;
                exit(1);
            }
            echo 'No duplicate IDs found.' . PHP_EOL;
          "
